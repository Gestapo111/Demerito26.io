<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instrumento No. 001 ‚Äî Tarjeta de Dem√©ritos</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --navy: #0d1f3c;
      --navy2: #162d52;
      --gold: #c8a84b;
      --gold-lt: #e8c96a;
      --cream: #f9f6f0;
      --red: #c0392b;
      --orange: #d35400;
      --green: #1e8449;
      --muted: #8a99b0;
      --border: #dce3ed;
      --radius: 8px;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 8px 24px rgba(0,0,0,0.12);
      --shadow-lg: 0 20px 60px rgba(0,0,0,0.35);
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--navy);
      background-image: 
        radial-gradient(ellipse at 20% 0%, rgba(30, 58, 110, 0.33) 0%, transparent 60%),
        radial-gradient(ellipse at 80% 100%, rgba(200, 168, 75, 0.13) 0%, transparent 60%);
      min-height: 100vh;
      padding: 24px 16px 40px;
      color: #222;
      line-height: 1.6;
    }
    
    /* TOOLBAR */
    .toolbar { 
      max-width: 1000px; 
      margin: 0 auto 24px; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      flex-wrap: wrap;
      padding: 0 8px;
    }
    
    .toolbar h1 { 
      font-family: 'DM Serif Display', serif; 
      color: var(--gold-lt); 
      font-size: 22px; 
      flex: 1; 
      letter-spacing: 0.02em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .btn-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      padding: 10px 20px; 
      border: none; 
      border-radius: 50px; 
      font-family: 'DM Sans', sans-serif; 
      font-size: 13px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: var(--transition);
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.2) 50%, transparent 70%);
      transform: translateX(-100%);
      transition: transform 0.6s;
    }
    
    .btn:hover::before {
      transform: translateX(100%);
    }
    
    .btn:hover { 
      transform: translateY(-2px); 
      box-shadow: var(--shadow-md);
    }
    
    .btn:active { 
      transform: translateY(0); 
    }
    
    .btn:disabled { 
      opacity: 0.6; 
      pointer-events: none; 
      cursor: not-allowed;
    }
    
    .btn-pdf { background: var(--gold); color: var(--navy); }
    .btn-excel { background: #1e8449; color: #fff; }
    .btn-print { background: #2c3e50; color: #fff; }
    .btn-add { background: var(--green); color: #fff; }
    .btn-clear { background: var(--red); color: #fff; }
    .btn-undo { background: #6c757d; color: #fff; }
    
    /* DOCUMENTO */
    .documento { 
      max-width: 1000px; 
      margin: 0 auto; 
      background: #fff; 
      border-radius: 16px; 
      box-shadow: var(--shadow-lg); 
      overflow: hidden;
      animation: slideUp 0.6s ease-out;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* HEADER */
    .header { 
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
      padding: 28px 32px; 
      display: grid; 
      grid-template-columns: 80px 1fr 80px; 
      align-items: center; 
      gap: 20px; 
      border-bottom: 4px solid var(--gold);
      position: relative;
    }
    
    .header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--gold), transparent);
    }
    
    .logo-circle { 
      width: 80px; 
      height: 80px; 
      border-radius: 50%; 
      background: rgba(255,255,255,0.08); 
      border: 2px solid var(--gold); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 11px; 
      color: var(--gold); 
      text-align: center; 
      font-weight: 600;
      transition: var(--transition);
    }
    
    .logo-circle:hover {
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(200, 168, 75, 0.3);
    }
    
    .header-center { 
      text-align: center; 
    }
    
    .header-center h2 { 
      font-family: 'DM Serif Display', serif; 
      color: #fff; 
      font-size: 28px; 
      letter-spacing: 0.03em; 
      line-height: 1.2;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .header-center .sub { 
      color: var(--gold-lt); 
      font-size: 13px; 
      font-weight: 500; 
      margin-top: 6px; 
      letter-spacing: 0.08em; 
      text-transform: uppercase;
    }
    
    /* DOC BODY */
    .doc-body { 
      padding: 32px; 
    }
    
    /* SECCIONES */
    .section { 
      margin-bottom: 28px;
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section-title { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
      color: #fff; 
      padding: 10px 16px; 
      border-radius: var(--radius); 
      font-size: 12px; 
      font-weight: 700; 
      letter-spacing: 0.06em; 
      text-transform: uppercase; 
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
    }
    
    .section-title span { 
      font-size: 16px; 
    }
    
    /* INFO GRID */
    .info-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
      gap: 16px; 
    }
    
    .field { 
      display: flex; 
      flex-direction: column; 
      gap: 6px; 
    }
    
    .field.wide { 
      grid-column: span 2; 
    }
    
    .field label { 
      font-size: 11px; 
      font-weight: 700; 
      color: var(--muted); 
      letter-spacing: 0.07em; 
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .field label .required {
      color: var(--red);
    }
    
    .field input, .field select { 
      border: 2px solid var(--border); 
      border-radius: var(--radius); 
      padding: 10px 12px; 
      font-family: 'DM Sans', sans-serif; 
      font-size: 14px; 
      color: var(--navy); 
      background: var(--cream); 
      transition: var(--transition);
      width: 100%;
    }
    
    .field input:focus, .field select:focus { 
      outline: none; 
      border-color: var(--gold); 
      background: #fff; 
      box-shadow: 0 0 0 4px rgba(200,168,75,0.15);
    }
    
    .field input[readonly] { 
      background: #f0f2f5; 
      color: #555; 
      cursor: default;
    }
    
    .field input.error {
      border-color: var(--red);
      background: #fff5f5;
    }
    
    .input-with-btn { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
    }
    
    .input-with-btn input { 
      flex: 1; 
    }
    
    .btn-select { 
      flex-shrink: 0; 
      padding: 10px 16px; 
      background: var(--navy); 
      color: var(--gold-lt); 
      border: none; 
      border-radius: var(--radius); 
      font-size: 12px; 
      font-weight: 700; 
      cursor: pointer; 
      white-space: nowrap; 
      transition: var(--transition);
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-select:hover { 
      background: var(--navy2);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* LEYENDA */
    .legend { 
      display: flex; 
      gap: 24px; 
      flex-wrap: wrap; 
      background: linear-gradient(135deg, #f4f7fb 0%, #e8ecf5 100%);
      border: 2px solid var(--border); 
      border-radius: var(--radius); 
      padding: 16px 20px; 
      font-size: 12px; 
      margin-bottom: 28px;
    }
    
    .legend strong { 
      color: var(--navy); 
      margin-right: 6px; 
    }
    
    .badge { 
      display: inline-flex; 
      align-items: center; 
      gap: 6px; 
      padding: 4px 10px; 
      border-radius: 50px; 
      font-size: 11px; 
      font-weight: 700;
      transition: var(--transition);
    }
    
    .badge:hover {
      transform: scale(1.05);
    }
    
    .badge-dem { background: #fce8e6; color: var(--red); }
    .badge-red { background: #e8f4fd; color: #1a73b9; }
    .badge-rec { background: #e6f9ed; color: var(--green); }
    
    /* FILTROS Y B√öSQUEDA */
    .table-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .search-box {
      flex: 1;
      min-width: 200px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 14px 10px 40px;
      border: 2px solid var(--border);
      border-radius: var(--radius);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      transition: var(--transition);
      background: var(--cream) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238a99b0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='M21 21l-4.35-4.35'/%3E%3C/svg%3E") no-repeat 12px center;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--gold);
      background-color: #fff;
      box-shadow: 0 0 0 4px rgba(200,168,75,0.15);
    }
    
    .filter-group {
      display: flex;
      gap: 8px;
    }
    
    .filter-btn {
      padding: 8px 16px;
      border: 2px solid var(--border);
      background: #fff;
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      color: var(--muted);
    }
    
    .filter-btn:hover, .filter-btn.active {
      border-color: var(--gold);
      color: var(--navy);
      background: var(--cream);
    }
    
    /* TABLA */
    .table-wrap { 
      overflow-x: auto;
      border-radius: var(--radius);
      border: 2px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    
    table { 
      width: 100%; 
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
    }
    
    thead tr:first-child th { 
      background: linear-gradient(135deg, var(--navy2) 0%, var(--navy) 100%);
      color: #fff; 
      padding: 12px 8px; 
      font-weight: 700; 
      letter-spacing: 0.04em; 
      font-size: 11px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    thead tr:first-child th:first-child {
      border-top-left-radius: var(--radius);
    }
    
    thead tr:first-child th:last-child {
      border-top-right-radius: var(--radius);
    }
    
    thead tr:nth-child(2) th { 
      background: #e8ecf5; 
      color: var(--navy); 
      font-weight: 700; 
      padding: 8px 6px;
      font-size: 11px;
    }
    
    thead tr:nth-child(2) th.th-dem { 
      background: linear-gradient(135deg, #fce8e6 0%, #f5d5d1 100%);
      color: var(--red); 
    }
    
    thead tr:nth-child(2) th.th-red { 
      background: linear-gradient(135deg, #e0eefc 0%, #d0e4f7 100%);
      color: #1a73b9; 
    }
    
    thead tr:nth-child(2) th.th-rec { 
      background: linear-gradient(135deg, #e2f5e9 0%, #d0ecd9 100%);
      color: var(--green); 
    }
    
    tbody tr { 
      transition: var(--transition);
    }
    
    tbody tr:nth-child(even) { 
      background: #f9fafc; 
    }
    
    tbody tr:hover { 
      background: #f0f5ff;
      transform: scale(1.002);
    }
    
    tbody tr.hidden {
      display: none;
    }
    
    td { 
      border: 1px solid #dce3ed; 
      padding: 8px 6px; 
      vertical-align: middle; 
      text-align: center;
      transition: var(--transition);
    }
    
    td.num { 
      font-weight: 700; 
      color: var(--muted); 
      width: 32px;
      background: #f8f9fa;
    }
    
    td input[type="date"] { 
      border: 2px solid var(--border); 
      border-radius: 6px; 
      padding: 6px 8px; 
      font-size: 11px; 
      font-family: inherit; 
      background: var(--cream); 
      color: var(--navy); 
      width: 130px; 
      transition: var(--transition);
    }
    
    td input[type="date"]:focus { 
      outline: none; 
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(200,168,75,0.15);
    }
    
    td input[type="checkbox"] { 
      width: 20px; 
      height: 20px; 
      cursor: pointer; 
      accent-color: var(--navy);
      transition: var(--transition);
    }
    
    td input[type="checkbox"]:hover {
      transform: scale(1.1);
    }
    
    td.check-dem input[type="checkbox"] { accent-color: var(--red); }
    td.check-red input[type="checkbox"] { accent-color: #1a73b9; }
    td.check-rec input[type="checkbox"] { accent-color: var(--green); }
    
    td textarea, td input[type="text"].inline { 
      border: 2px solid var(--border); 
      border-radius: 6px; 
      padding: 6px 8px; 
      font-size: 11px; 
      font-family: inherit; 
      background: transparent; 
      resize: none; 
      width: 100%; 
      min-height: 36px; 
      transition: var(--transition);
    }
    
    td textarea:focus, td input[type="text"].inline:focus { 
      outline: none; 
      border-color: var(--gold); 
      background: #fffdf5;
      box-shadow: 0 0 0 3px rgba(200,168,75,0.15);
    }
    
    td.desc textarea { 
      min-height: 40px; 
      width: 150px; 
    }
    
    td.del-cell button { 
      background: none; 
      border: none; 
      color: #ccc; 
      font-size: 18px; 
      cursor: pointer; 
      padding: 6px 8px; 
      border-radius: 6px; 
      transition: var(--transition);
      line-height: 1;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    td.del-cell button:hover { 
      color: var(--red); 
      background: #fce8e6;
      transform: scale(1.1);
    }
    
    /* PROGRESO */
    .progress-wrap { 
      margin: 0 0 28px; 
    }
    
    .progress-label { 
      display: flex; 
      justify-content: space-between; 
      font-size: 12px; 
      font-weight: 600; 
      color: var(--muted); 
      margin-bottom: 8px;
    }
    
    .progress-bar-bg { 
      background: #e8ecf5; 
      border-radius: 50px; 
      height: 12px; 
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .progress-bar { 
      height: 100%; 
      border-radius: 50px; 
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1), background 0.4s;
      position: relative;
      overflow: hidden;
    }
    
    .progress-bar::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* RESUMEN */
    .summary { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 16px; 
      margin: 28px 0; 
    }
    
    .stat-card { 
      border-radius: 12px; 
      padding: 20px; 
      text-align: center; 
      position: relative; 
      overflow: hidden; 
      transition: var(--transition);
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    .stat-card:hover { 
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }
    
    .stat-card.active {
      border-color: var(--gold);
      box-shadow: 0 0 0 4px rgba(200,168,75,0.2);
    }
    
    .stat-card::before { 
      content: ''; 
      position: absolute; 
      inset: 0; 
      opacity: 0.07; 
      background: repeating-linear-gradient(45deg, #fff 0, #fff 2px, transparent 2px, transparent 8px); 
    }
    
    .stat-card .val { 
      font-family: 'DM Serif Display', serif; 
      font-size: 48px; 
      line-height: 1;
      transition: var(--transition);
    }
    
    .stat-card:hover .val {
      transform: scale(1.1);
    }
    
    .stat-card .lbl { 
      font-size: 12px; 
      font-weight: 600; 
      margin-top: 8px; 
      letter-spacing: 0.04em; 
      text-transform: uppercase; 
      opacity: 0.85; 
    }
    
    .stat-dem { background: linear-gradient(135deg, #fce8e6 0%, #f5d5d1 100%); color: var(--red); }
    .stat-red { background: linear-gradient(135deg, #e0eefc 0%, #d0e4f7 100%); color: #1a73b9; }
    .stat-net { background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%); color: #fff; }
    .stat-rec { background: linear-gradient(135deg, #e2f5e9 0%, #d0ecd9 100%); color: var(--green); }
    
    /* SANCI√ìN */
    .sanction { 
      border-radius: 12px; 
      padding: 18px 24px; 
      display: flex; 
      align-items: center; 
      gap: 16px; 
      margin-bottom: 28px; 
      font-weight: 600; 
      font-size: 15px; 
      transition: var(--transition);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0.1); }
      50% { box-shadow: 0 0 0 8px rgba(0,0,0,0); }
    }
    
    .sanction-icon { 
      font-size: 32px; 
      flex-shrink: 0; 
      animation: bounce 1s infinite;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    .sanction-text { 
      line-height: 1.5; 
      flex: 1;
    }
    
    .sanction-text small { 
      display: block; 
      font-size: 12px; 
      font-weight: 400; 
      opacity: 0.8; 
      margin-top: 4px; 
    }
    
    .s-none { background: linear-gradient(135deg, #e6f9ed 0%, #d0ecd9 100%); color: var(--green); animation: none; }
    .s-warn { background: linear-gradient(135deg, #fef9e7 0%, #fcf3cf 100%); color: #b7950b; }
    .s-comms { background: linear-gradient(135deg, #fef2e0 0%, #fdebd0 100%); color: var(--orange); }
    .s-susp { background: linear-gradient(135deg, #fce8e6 0%, #f5d5d1 100%); color: var(--red); }
    .s-noprom { background: linear-gradient(135deg, var(--red) 0%, #a93226 100%); color: #fff; }
    
    /* FIRMA */
    .firma-section { 
      margin-top: 40px; 
      padding-top: 28px; 
      border-top: 2px solid var(--border); 
      display: flex; 
      justify-content: center; 
    }
    
    .firma-box { 
      text-align: center; 
      min-width: 320px; 
    }
    
    .firma-line { 
      border-top: 2px solid var(--navy); 
      padding-top: 12px; 
      font-size: 12px; 
      font-weight: 600; 
      color: var(--navy);
      letter-spacing: 0.02em;
    }
    
    /* MODAL ESTUDIANTE */
    .modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(10,20,40,0.75); 
      backdrop-filter: blur(6px); 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      opacity: 0; 
      pointer-events: none; 
      transition: opacity 0.3s ease;
    }
    
    .modal-overlay.open { 
      opacity: 1; 
      pointer-events: all; 
    }
    
    .modal { 
      background: #fff; 
      border-radius: 16px; 
      width: 560px; 
      max-width: 95vw; 
      max-height: 85vh; 
      display: flex; 
      flex-direction: column; 
      box-shadow: 0 32px 80px rgba(0,0,0,0.5); 
      transform: translateY(24px) scale(0.95); 
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
      overflow: hidden; 
    }
    
    .modal-overlay.open .modal { 
      transform: translateY(0) scale(1); 
    }
    
    .modal-header { 
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%);
      padding: 20px 24px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      border-bottom: 3px solid var(--gold); 
      flex-shrink: 0; 
    }
    
    .modal-header h3 { 
      font-family: 'DM Serif Display', serif; 
      color: #fff; 
      font-size: 20px; 
      letter-spacing: 0.02em; 
    }
    
    .modal-header p { 
      color: var(--gold-lt); 
      font-size: 12px; 
      margin-top: 4px; 
    }
    
    .modal-close { 
      background: rgba(255,255,255,0.12); 
      border: none; 
      color: #fff; 
      font-size: 20px; 
      width: 36px; 
      height: 36px; 
      border-radius: 50%; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      transition: var(--transition);
      flex-shrink: 0; 
    }
    
    .modal-close:hover { 
      background: rgba(255,255,255,0.25);
      transform: rotate(90deg);
    }
    
    .modal-search-wrap { 
      padding: 16px 20px 12px; 
      flex-shrink: 0; 
      border-bottom: 2px solid var(--border); 
    }
    
    .modal-search { 
      width: 100%; 
      border: 2px solid var(--border); 
      border-radius: 50px; 
      padding: 12px 18px 12px 44px; 
      font-family: 'DM Sans', sans-serif; 
      font-size: 14px; 
      color: var(--navy); 
      background: var(--cream) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238a99b0' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='M21 21l-4.35-4.35'/%3E%3C/svg%3E") no-repeat 16px center; 
      transition: var(--transition);
    }
    
    .modal-search:focus { 
      outline: none; 
      border-color: var(--gold); 
      box-shadow: 0 0 0 4px rgba(200,168,75,0.15); 
      background-color: #fff; 
    }
    
    .modal-list { 
      overflow-y: auto; 
      flex: 1; 
      padding: 12px; 
    }
    
    .modal-item { 
      display: flex; 
      align-items: center; 
      gap: 16px; 
      padding: 14px 16px; 
      border-radius: 10px; 
      cursor: pointer; 
      transition: var(--transition);
      border: 2px solid transparent; 
      margin-bottom: 8px;
    }
    
    .modal-item:hover { 
      background: #f0f5ff; 
      border-color: #c8d8f8;
      transform: translateX(4px);
    }
    
    .modal-item.selected { 
      background: #e8f0fe; 
      border-color: var(--gold);
    }
    
    .modal-num { 
      width: 32px; 
      height: 32px; 
      border-radius: 50%; 
      background: var(--navy); 
      color: #fff; 
      font-size: 12px; 
      font-weight: 700; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      flex-shrink: 0;
      transition: var(--transition);
    }
    
    .modal-item:hover .modal-num {
      background: var(--gold);
      color: var(--navy);
    }
    
    .modal-info { 
      flex: 1; 
    }
    
    .modal-info .est-name { 
      font-size: 14px; 
      font-weight: 600; 
      color: var(--navy); 
      letter-spacing: 0.01em; 
    }
    
    .modal-info .est-nie { 
      font-size: 12px; 
      color: var(--muted); 
      margin-top: 2px; 
    }
    
    .modal-no-results { 
      text-align: center; 
      color: var(--muted); 
      font-size: 14px; 
      padding: 40px 0; 
    }
    
    /* MODALES CONFIRMACI√ìN */
    .confirm-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(10,20,40,0.65); 
      backdrop-filter: blur(4px); 
      z-index: 1100; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      opacity: 0; 
      pointer-events: none; 
      transition: opacity 0.3s ease;
    }
    
    .confirm-overlay.open { 
      opacity: 1; 
      pointer-events: all; 
    }
    
    .confirm-box { 
      background: #fff; 
      border-radius: 16px; 
      width: 460px; 
      max-width: 94vw; 
      box-shadow: 0 32px 80px rgba(0,0,0,0.4); 
      overflow: hidden; 
      transform: scale(0.9) translateY(20px); 
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
    }
    
    .confirm-overlay.open .confirm-box { 
      transform: scale(1) translateY(0); 
    }
    
    .confirm-header { 
      padding: 20px 24px 16px; 
      border-bottom: 3px solid; 
    }
    
    .confirm-header.red-theme { 
      background: linear-gradient(135deg, #1a6fa0 0%, #145a84 100%);
      border-color: #4fb3e8; 
    }
    
    .confirm-header.rec-theme { 
      background: linear-gradient(135deg, #1a7a3e 0%, #145a2e 100%);
      border-color: #4cca7a; 
    }
    
    .confirm-header h3 { 
      font-family: 'DM Serif Display', serif; 
      color: #fff; 
      font-size: 18px; 
    }
    
    .confirm-header p { 
      color: rgba(255,255,255,0.8); 
      font-size: 12px; 
      margin-top: 4px; 
    }
    
    .confirm-body { 
      padding: 24px; 
    }
    
    .confirm-item { 
      display: flex; 
      align-items: flex-start; 
      gap: 14px; 
      padding: 16px; 
      border-radius: 10px; 
      margin-bottom: 12px; 
      border: 2px solid var(--border); 
      background: #f8fafd; 
      transition: var(--transition);
    }
    
    .confirm-item:hover {
      border-color: var(--gold);
      background: #fffdf5;
    }
    
    .confirm-letter { 
      width: 36px; 
      height: 36px; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: 800; 
      font-size: 14px; 
      flex-shrink: 0; 
      margin-top: 2px;
      transition: var(--transition);
    }
    
    .red-theme-letter { 
      background: linear-gradient(135deg, #1a6fa0 0%, #145a84 100%);
      color: #fff; 
    }
    
    .rec-theme-letter { 
      background: linear-gradient(135deg, #1a7a3e 0%, #145a2e 100%);
      color: #fff; 
    }
    
    .confirm-item-text { 
      font-size: 14px; 
      color: var(--navy); 
      line-height: 1.6; 
    }
    
    .confirm-footer { 
      padding: 16px 24px 20px; 
      display: flex; 
      gap: 12px; 
      justify-content: flex-end; 
      border-top: 2px solid var(--border); 
    }
    
    .btn-cancel-c { 
      padding: 10px 24px; 
      border: 2px solid var(--border); 
      border-radius: 50px; 
      background: #fff; 
      color: var(--muted); 
      font-family: 'DM Sans', sans-serif; 
      font-size: 13px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: var(--transition);
    }
    
    .btn-cancel-c:hover { 
      background: #f0f2f5;
      border-color: var(--muted);
      color: var(--navy);
    }
    
    .btn-confirm-red { 
      padding: 10px 24px; 
      border: none; 
      border-radius: 50px; 
      background: linear-gradient(135deg, #1a6fa0 0%, #145a84 100%);
      color: #fff; 
      font-family: 'DM Sans', sans-serif; 
      font-size: 13px; 
      font-weight: 700; 
      cursor: pointer; 
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(26, 111, 160, 0.3);
    }
    
    .btn-confirm-red:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26, 111, 160, 0.4);
    }
    
    .btn-confirm-rec { 
      padding: 10px 24px; 
      border: none; 
      border-radius: 50px; 
      background: linear-gradient(135deg, #1a7a3e 0%, #145a2e 100%);
      color: #fff; 
      font-family: 'DM Sans', sans-serif; 
      font-size: 13px; 
      font-weight: 700; 
      cursor: pointer; 
      transition: var(--transition);
      box-shadow: 0 4px 12px rgba(26, 122, 62, 0.3);
    }
    
    .btn-confirm-rec:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(26, 122, 62, 0.4);
    }
    
    /* TOAST NOTIFICATIONS */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      background: #fff;
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideInRight 0.4s ease;
      border-left: 4px solid var(--gold);
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .toast.success { border-left-color: var(--green); }
    .toast.error { border-left-color: var(--red); }
    .toast.warning { border-left-color: var(--orange); }
    
    .toast-icon {
      font-size: 24px;
    }
    
    .toast-content {
      flex: 1;
    }
    
    .toast-title {
      font-weight: 700;
      font-size: 14px;
      color: var(--navy);
    }
    
    .toast-message {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    
    .toast-close {
      background: none;
      border: none;
      font-size: 18px;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: var(--transition);
    }
    
    .toast-close:hover {
      background: #f0f2f5;
      color: var(--navy);
    }
    
    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--navy);
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: 14px;
    }
    
    /* PRINT */
    @media print {
      body { 
        background: #fff; 
        padding: 0; 
      }
      
      .toolbar, .toast-container, .table-controls, .del-cell, .btn-select { 
        display: none !important; 
      }
      
      .documento { 
        max-width: 100%; 
        box-shadow: none; 
        border-radius: 0;
        animation: none;
      }
      
      .sanction {
        animation: none;
      }
      
      .progress-bar::after {
        display: none;
      }
    }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      .doc-body { 
        padding: 20px; 
      }
      
      .header { 
        padding: 20px;
        grid-template-columns: 1fr;
        text-align: center;
      }
      
      .logo-circle {
        display: none;
      }
      
      .field.wide { 
        grid-column: span 1; 
      }
      
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .toolbar h1 {
        text-align: center;
        margin-bottom: 12px;
      }
      
      .btn-group {
        justify-content: center;
      }
      
      .summary {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .stat-card .val {
        font-size: 36px;
      }
      
      .legend {
        flex-direction: column;
        gap: 12px;
      }
      
      .table-controls {
        flex-direction: column;
      }
      
      .search-box {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .summary {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* SCROLLBAR STYLING */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--navy);
    }
    
    /* LOADING SPINNER */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <!-- TOAST CONTAINER -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- TOOLBAR -->
  <div class="toolbar">
    <h1>üìã Tarjeta de Dem√©ritos</h1>
    <div class="btn-group">
      <button class="btn btn-add" onclick="app.addRow()" title="Agregar nueva fila (Ctrl+N)">
        <span>‚ûï</span> Agregar fila
      </button>
      <button class="btn btn-undo" onclick="app.undo()" title="Deshacer √∫ltima acci√≥n (Ctrl+Z)">
        <span>‚Ü©Ô∏è</span> Deshacer
      </button>
      <button class="btn btn-pdf" id="btnPDF" onclick="app.exportPDF()" title="Guardar como PDF">
        <span>üíæ</span> Guardar PDF
      </button>
      <button class="btn btn-excel" onclick="app.exportExcel()" title="Exportar a Excel">
        <span>üìä</span> Excel
      </button>
      <button class="btn btn-print" onclick="window.print()" title="Imprimir documento">
        <span>üñ®Ô∏è</span> Imprimir
      </button>
      <button class="btn btn-clear" onclick="app.clearForm()" title="Limpiar todo el formulario">
        <span>üóëÔ∏è</span> Limpiar
      </button>
    </div>
  </div>

  <!-- DOCUMENTO -->
  <div class="documento" id="contenidoPDF">
    <div class="header">
      <div class="logo-circle">Logo<br>C.E.</div>
      <div class="header-center">
        <h2>Instrumento No. 001</h2>
        <div class="sub">Tarjeta de Dem√©ritos del Estudiante</div>
      </div>
      <div class="logo-circle">Escudo<br>Inst.</div>
    </div>

    <div class="doc-body">

      <!-- CENTRO EDUCATIVO -->
      <div class="section">
        <div class="section-title"><span>üè´</span> Informaci√≥n del Centro Educativo</div>
        <div class="info-grid">
          <div class="field wide">
            <label>Centro Educativo</label>
            <input type="text" value="COMPLEJO EDUCATIVO CANT√ìN SAN ISIDRO" readonly>
          </div>
          <div class="field">
            <label>C√≥digo</label>
            <input type="text" value="70056" readonly>
          </div>
          <div class="field">
            <label>Departamento</label>
            <input type="text" value="SAN SALVADOR" readonly>
          </div>
          <div class="field">
            <label>Municipio</label>
            <input type="text" value="PANCHIMALCO" readonly>
          </div>
          <div class="field">
            <label>Distrito</label>
            <input type="text" value="06-14" readonly>
          </div>
        </div>
      </div>

      <!-- ESTUDIANTE -->
      <div class="section">
        <div class="section-title"><span>üë§</span> Informaci√≥n del Estudiante</div>
        <div class="info-grid">
          <div class="field wide">
            <label>Nombre completo <span class="required">*</span></label>
            <div class="input-with-btn">
              <input type="text" id="nombreEstudiante" placeholder="Seleccione de la lista" autocomplete="off" readonly>
              <button class="btn-select" onclick="app.openStudentModal()">
                <span>üë•</span> Seleccionar
              </button>
            </div>
          </div>
          <div class="field">
            <label>NIE <span class="required">*</span></label>
            <input type="text" id="nie" placeholder="N√∫mero de IE" readonly>
          </div>
          <div class="field">
            <label>Sexo</label>
            <select id="sexo">
              <option value="">Seleccione</option>
              <option value="Mujer">Mujer</option>
              <option value="Hombre">Hombre</option>
            </select>
          </div>
          <div class="field">
            <label>Grado / Secci√≥n</label>
            <input type="text" id="grado" placeholder="Ej: 9¬∞A">
          </div>
          <div class="field">
            <label>Turno</label>
            <select id="turno">
              <option value="">Seleccione</option>
              <option value="Matutino">Matutino</option>
              <option value="Vespertino">Vespertino</option>
              <option value="Nocturno">Nocturno</option>
            </select>
          </div>
          <div class="field">
            <label>A√±o lectivo</label>
            <input type="text" id="anio" placeholder="Ej: 2025">
          </div>
        </div>
      </div>

      <!-- LEYENDA -->
      <div class="legend">
        <div>
          <span class="badge badge-dem">D A‚ÄìD</span>
          <strong>Dem√©ritos</strong> ‚Äî Falta que suma puntos negativos
        </div>
        <div>
          <span class="badge badge-red">R A‚ÄìC</span>
          <strong>Redenci√≥n</strong> ‚Äî Acci√≥n positiva que descuenta dem√©ritos
        </div>
        <div>
          <span class="badge badge-rec">RC A‚ÄìB</span>
          <strong>Reconocimiento</strong> ‚Äî M√©rito destacado (no descuenta)
        </div>
      </div>

      <!-- TABLA -->
      <div class="section">
        <div class="section-title"><span>üìä</span> Registro de Dem√©ritos y Reconocimientos</div>
        
        <!-- Controles de tabla -->
        <div class="table-controls">
          <div class="search-box">
            <input type="text" id="tableSearch" placeholder="Buscar en la tabla..." oninput="app.filterTable()">
          </div>
          <div class="filter-group">
            <button class="filter-btn active" onclick="app.setFilter('all')" data-filter="all">Todos</button>
            <button class="filter-btn" onclick="app.setFilter('dem')" data-filter="dem">Dem√©ritos</button>
            <button class="filter-btn" onclick="app.setFilter('red')" data-filter="red">Redenciones</button>
            <button class="filter-btn" onclick="app.setFilter('rec')" data-filter="rec">Reconocimientos</button>
          </div>
        </div>
        
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th rowspan="2">#</th>
                <th rowspan="2">Fecha</th>
                <th rowspan="2">Descripci√≥n</th>
                <th colspan="4" style="background: linear-gradient(135deg, #b03a2e 0%, #922b21 100%);">Dem√©ritos (D)</th>
                <th colspan="3" style="background: linear-gradient(135deg, #1a6fa0 0%, #145a84 100%);">Redenci√≥n (R)</th>
                <th colspan="2" style="background: linear-gradient(135deg, #1a7a3e 0%, #145a2e 100%);">Reconoc. (RC)</th>
                <th rowspan="2">Docente</th>
                <th rowspan="2">Firma padre</th>
                <th rowspan="2">Firma estudiante</th>
                <th rowspan="2" class="del-cell"></th>
              </tr>
              <tr>
                <th class="th-dem">A</th>
                <th class="th-dem">B</th>
                <th class="th-dem">C</th>
                <th class="th-dem">D</th>
                <th class="th-red">A</th>
                <th class="th-red">B</th>
                <th class="th-red">C</th>
                <th class="th-rec">A</th>
                <th class="th-rec">B</th>
              </tr>
            </thead>
            <tbody id="tabla"></tbody>
          </table>
        </div>
        
        <!-- Empty state (hidden by default) -->
        <div class="empty-state" id="emptyState" style="display: none;">
          <div class="empty-state-icon">üìã</div>
          <div class="empty-state-title">No hay registros</div>
          <div class="empty-state-text">Haga clic en "Agregar fila" para comenzar a registrar dem√©ritos, redenciones o reconocimientos.</div>
        </div>
      </div>

      <!-- PROGRESO -->
      <div class="progress-wrap">
        <div class="progress-label">
          <span>Progreso de dem√©ritos netos</span>
          <span id="progressLabel">0 / 15</span>
        </div>
        <div class="progress-bar-bg">
          <div class="progress-bar" id="progressBar" style="width: 0%; background: #27ae60;"></div>
        </div>
      </div>

      <!-- RESUMEN -->
      <div class="summary">
        <div class="stat-card stat-dem" onclick="app.setFilter('dem')" title="Ver solo dem√©ritos">
          <div class="val" id="totalDem">0</div>
          <div class="lbl">Dem√©ritos totales</div>
        </div>
        <div class="stat-card stat-red" onclick="app.setFilter('red')" title="Ver solo redenciones">
          <div class="val" id="totalRed">0</div>
          <div class="lbl">Redenciones</div>
        </div>
        <div class="stat-card stat-net" onclick="app.setFilter('all')" title="Ver todos">
          <div class="val" id="totalNet">0</div>
          <div class="lbl">Dem√©ritos netos</div>
        </div>
        <div class="stat-card stat-rec" onclick="app.setFilter('rec')" title="Ver solo reconocimientos">
          <div class="val" id="totalRec">0</div>
          <div class="lbl">Reconocimientos</div>
        </div>
      </div>

      <!-- SANCI√ìN -->
      <div class="sanction s-none" id="sancion">
        <div class="sanction-icon">‚úÖ</div>
        <div class="sanction-text">
          Sin sanci√≥n acumulada
          <small>0 dem√©ritos netos ‚Äî contin√∫e observando la conducta del estudiante</small>
        </div>
      </div>

      <!-- FIRMA -->
      <div class="firma-section">
        <div class="firma-box">
          <div style="height: 60px;"></div>
          <div class="firma-line">Nombre, firma y sello del Director(a) del C.E.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- MODAL ESTUDIANTE -->
  <div class="modal-overlay" id="modalOverlay" onclick="app.closeModalOverlay(event)">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <div>
          <h3>Seleccionar Estudiante</h3>
          <p>Haga clic en un nombre para autocompletar el formulario</p>
        </div>
        <button class="modal-close" onclick="app.closeStudentModal()">‚úï</button>
      </div>
      <div class="modal-search-wrap">
        <input type="text" class="modal-search" id="modalSearch" placeholder="Buscar por nombre o NIE..." oninput="app.filterStudents()" autocomplete="off">
      </div>
      <div class="modal-list" id="modalList"></div>
    </div>
  </div>

  <!-- MODAL CONFIRMACI√ìN REDENCI√ìN -->
  <div class="confirm-overlay" id="confirmRedOverlay">
    <div class="confirm-box">
      <div class="confirm-header red-theme">
        <h3>‚úî Confirmar Redenci√≥n</h3>
        <p>¬øDesea registrar la siguiente acci√≥n de redenci√≥n?</p>
      </div>
      <div class="confirm-body" id="confirmRedBody"></div>
      <div class="confirm-footer">
        <button class="btn-cancel-c" onclick="app.cancelConfirm('red')">Cancelar</button>
        <button class="btn-confirm-red" onclick="app.acceptConfirm('red')">‚úî Confirmar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIRMACI√ìN RECONOCIMIENTO -->
  <div class="confirm-overlay" id="confirmRecOverlay">
    <div class="confirm-box">
      <div class="confirm-header rec-theme">
        <h3>üèÖ Confirmar Reconocimiento</h3>
        <p>¬øDesea registrar el siguiente reconocimiento?</p>
      </div>
      <div class="confirm-body" id="confirmRecBody"></div>
      <div class="confirm-footer">
        <button class="btn-cancel-c" onclick="app.cancelConfirm('rec')">Cancelar</button>
        <button class="btn-confirm-rec" onclick="app.acceptConfirm('rec')">‚úî Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    /**
     * Tarjeta de Dem√©ritos - Aplicaci√≥n Mejorada
     * Versi√≥n 2.0 - C√≥digo modular y mantenible
     */
    
    const app = (function() {
      'use strict';
      
      // ==================== CONFIGURACI√ìN ====================
      
      const CONFIG = {
        MAX_ROWS: 50,
        DEFAULT_ROWS: 12,
        STORAGE_KEY: 'ce_demeritos_data_v2',
        STUDENT_KEY: 'ce_demeritos_estudiante_v2',
        HISTORY_KEY: 'ce_demeritos_history',
        MAX_HISTORY: 20
      };
      
      // ==================== DATOS ====================
      
      const STUDENTS = [
        { no: 1, nie: '10192638', nombre: 'ACOSTA DEODANES, CAROLINA LISSETH', sexo: 'Mujer' },
        { no: 2, nie: '20085229', nombre: 'AGUILAR ORTIZ, CESAR ISMAEL', sexo: 'Hombre' },
        { no: 3, nie: '20085270', nombre: 'BENITEZ PEREZ, OSCAR EFRAIN', sexo: 'Hombre' },
        { no: 4, nie: '20085307', nombre: 'CARRILLO VENTURA, RUTH NOEMY', sexo: 'Mujer' },
        { no: 5, nie: '19933288', nombre: 'CASTRO ORTIZ, JAZMIN SARAI', sexo: 'Mujer' },
        { no: 6, nie: '20008551', nombre: 'CORNEJO ORTIZ, PAMELA GUADALUPE', sexo: 'Mujer' },
        { no: 7, nie: '19933292', nombre: 'CRUZ GARC√çA, JHAMILTON GEOVANY', sexo: 'Hombre' },
        { no: 8, nie: '10380636', nombre: 'CRUZ VEGA, JUANA ELENA', sexo: 'Mujer' },
        { no: 9, nie: '20085334', nombre: 'DEODANES JORGE, DAVID ALEXANDER', sexo: 'Hombre' },
        { no: 10, nie: '20161320', nombre: 'DEODANES P√âREZ, CARLOS DANIEL', sexo: 'Hombre' },
        { no: 11, nie: '19933320', nombre: 'DEODANES RODRIGUEZ, WILLIAN LEONEL', sexo: 'Hombre' },
        { no: 12, nie: '20161321', nombre: 'DEODANES SANTOS, KATHERIN MARITZA', sexo: 'Mujer' },
        { no: 13, nie: '20116603', nombre: 'JORGE BENITEZ, XAVIER ERNESTO', sexo: 'Hombre' },
        { no: 14, nie: '20116605', nombre: 'LEON RODRIGUEZ, JEFFERSON ALEXIS', sexo: 'Hombre' },
        { no: 15, nie: '20116607', nombre: 'MARTINEZ PEREZ, MANUEL ENRIQUE', sexo: 'Hombre' },
        { no: 16, nie: '20116608', nombre: 'MARTINEZ VASQUEZ, ANDERSON MAURICIO', sexo: 'Hombre' },
        { no: 17, nie: '20161327', nombre: 'MART√çNEZ MIRANDA, JOS√â BRYAN', sexo: 'Hombre' },
        { no: 18, nie: '20116614', nombre: 'MENDEZ PEREZ, JORGE ERNESTO', sexo: 'Hombre' },
        { no: 19, nie: '19964662', nombre: 'ORTIZ MART√çNEZ, JOSELYN ROXANA', sexo: 'Mujer' },
        { no: 20, nie: '20116635', nombre: 'PEREZ JACINTO, ROSIBEL', sexo: 'Mujer' },
        { no: 21, nie: '19964672', nombre: 'P√âREZ DEODANES, ISA√çAS ARMANDO', sexo: 'Hombre' },
        { no: 22, nie: '20116666', nombre: 'VASQUEZ BENITES, DORIS ESTEFANNY', sexo: 'Mujer' },
        { no: 23, nie: '20116669', nombre: 'VASQUEZ MARTINEZ, NELSON ANTONIO', sexo: 'Hombre' },
        { no: 24, nie: '20116683', nombre: 'VENITES RODRIGUEZ, SERGIO JAVIER', sexo: 'Hombre' }
      ];
      
      const SANCTIONS = [
        { min: 15, cls: 's-noprom', icon: 'üö´', title: 'No promoci√≥n de grado', sub: '15 o m√°s dem√©ritos netos ‚Äî consecuencia m√°xima' },
        { min: 10, cls: 's-susp', icon: '‚õî', title: 'Suspensi√≥n de privilegios', sub: '10‚Äì14 dem√©ritos netos ‚Äî revisar con direcci√≥n' },
        { min: 6, cls: 's-comms', icon: 'üìû', title: 'Comunicaci√≥n a la familia', sub: '6‚Äì9 dem√©ritos netos ‚Äî citar al padre/madre o responsable' },
        { min: 3, cls: 's-warn', icon: '‚ö°', title: 'Advertencia formal', sub: '3‚Äì5 dem√©ritos netos ‚Äî registrar en expediente' },
        { min: 0, cls: 's-none', icon: '‚úÖ', title: 'Sin sanci√≥n acumulada', sub: '0‚Äì2 dem√©ritos netos ‚Äî contin√∫e observando la conducta' }
      ];
      
      const DEMERIT_TYPES = {
        dem: [
          { letter: 'A', desc: 'No saludar al entrar o al salir del aula.' },
          { letter: 'B', desc: 'Omitir "Por favor" al hacer una petici√≥n.' },
          { letter: 'C', desc: 'Omitir "Gracias" al recibir un favor, material o atenci√≥n.' },
          { letter: 'D', desc: 'Usar un tono grosero o irrespetuoso hacia compa√±eros, docentes o personal.' }
        ],
        red: [
          { letter: 'A', desc: 'Cumplir una semana completa con saludos y expresiones de cortes√≠a ejemplares.' },
          { letter: 'B', desc: 'Apoyar voluntariamente en actividades de orden y limpieza escolar.' },
          { letter: 'C', desc: 'Participar en campa√±as de valores organizadas por el centro educativo.' }
        ],
        rec: [
          { letter: 'A', desc: 'Diplomas.' },
          { letter: 'B', desc: 'Menciones en Murales Escolares.' }
        ]
      };
      
      // ==================== ESTADO ====================
      
      let state = {
        rowCount: 0,
        selectedStudent: null,
        pendingCheckbox: null,
        currentFilter: 'all',
        history: [],
        historyIndex: -1
      };
      
      // ==================== UTILIDADES ====================
      
      const utils = {
        /**
         * Genera un ID √∫nico
         */
        generateId() {
          return Date.now().toString(36) + Math.random().toString(36).substr(2);
        },
        
        /**
         * Formatea texto para resaltar b√∫squeda
         */
        highlightText(text, query) {
          if (!query) return text;
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          return text.replace(new RegExp(`(${escaped})`, 'gi'), '<mark style="background: #fff3cd; border-radius: 3px; padding: 1px 3px; font-weight: 600;">$1</mark>');
        },
        
        /**
         * Obtiene turno autom√°tico basado en hora
         */
        getAutoShift() {
          const hour = new Date().getHours();
          return hour < 12 ? 'Matutino' : hour < 18 ? 'Vespertino' : 'Nocturno';
        },
        
        /**
         * Formatea fecha para input date
         */
        formatDate(date = new Date()) {
          return date.toISOString().split('T')[0];
        },
        
        /**
         * Guarda en localStorage con manejo de errores
         */
        saveToStorage(key, data) {
          try {
            localStorage.setItem(key, JSON.stringify(data));
            return true;
          } catch (e) {
            console.warn('Error saving to localStorage:', e);
            return false;
          }
        },
        
        /**
         * Carga de localStorage con manejo de errores
         */
        loadFromStorage(key, defaultValue = null) {
          try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : defaultValue;
          } catch (e) {
            console.warn('Error loading from localStorage:', e);
            return defaultValue;
          }
        },
        
        /**
         * Debounce para eventos frecuentes
         */
        debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }
      };
      
      // ==================== NOTIFICACIONES ====================
      
      const notifications = {
        container: document.getElementById('toastContainer'),
        
        show(message, type = 'info', title = '', duration = 4000) {
          const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
          };
          
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.innerHTML = `
            <div class="toast-icon">${icons[type] || icons.info}</div>
            <div class="toast-content">
              <div class="toast-title">${title || type.charAt(0).toUpperCase() + type.slice(1)}</div>
              <div class="toast-message">${message}</div>
            </div>
            <button class="toast-close" onclick="this.parentElement.remove()">‚úï</button>
          `;
          
          this.container.appendChild(toast);
          
          if (duration > 0) {
            setTimeout(() => {
              toast.style.animation = 'slideInRight 0.4s ease reverse';
              setTimeout(() => toast.remove(), 400);
            }, duration);
          }
          
          return toast;
        },
        
        success(message, title = '√âxito') {
          return this.show(message, 'success', title);
        },
        
        error(message, title = 'Error') {
          return this.show(message, 'error', title);
        },
        
        warning(message, title = 'Advertencia') {
          return this.show(message, 'warning', title);
        },
        
        info(message, title = 'Informaci√≥n') {
          return this.show(message, 'info', title);
        }
      };
      
      // ==================== HISTORIAL (UNDO/REDO) ====================
      
      const historyManager = {
        save() {
          const data = {
            rows: tableManager.getAllRowsData(),
            student: studentManager.getStudentData(),
            timestamp: Date.now()
          };
          
          // Eliminar historial futuro si estamos en medio de la pila
          if (state.historyIndex < state.history.length - 1) {
            state.history = state.history.slice(0, state.historyIndex + 1);
          }
          
          state.history.push(data);
          
          // Limitar tama√±o del historial
          if (state.history.length > CONFIG.MAX_HISTORY) {
            state.history.shift();
          } else {
            state.historyIndex++;
          }
          
          utils.saveToStorage(CONFIG.HISTORY_KEY, state.history);
        },
        
        undo() {
          if (state.historyIndex > 0) {
            state.historyIndex--;
            const data = state.history[state.historyIndex];
            this.restore(data);
            notifications.info('Acci√≥n deshecha', 'Deshacer');
            return true;
          }
          notifications.warning('No hay acciones para deshacer');
          return false;
        },
        
        redo() {
          if (state.historyIndex < state.history.length - 1) {
            state.historyIndex++;
            const data = state.history[state.historyIndex];
            this.restore(data);
            notifications.info('Acci√≥n rehecha', 'Rehacer');
            return true;
          }
          notifications.warning('No hay acciones para rehacer');
          return false;
        },
        
        restore(data) {
          if (data.student) {
            studentManager.setStudentData(data.student);
          }
          if (data.rows) {
            tableManager.loadRowsData(data.rows);
          }
          calculations.recalculate();
        },
        
        init() {
          const saved = utils.loadFromStorage(CONFIG.HISTORY_KEY, []);
          if (saved.length > 0) {
            state.history = saved;
            state.historyIndex = saved.length - 1;
          }
        }
      };
      
      // ==================== GESTI√ìN DE ESTUDIANTES ====================
      
      const studentManager = {
        openModal() {
          const overlay = document.getElementById('modalOverlay');
          const searchInput = document.getElementById('modalSearch');
          
          searchInput.value = '';
          this.renderList(STUDENTS);
          overlay.classList.add('open');
          
          setTimeout(() => searchInput.focus(), 100);
        },
        
        closeModal() {
          document.getElementById('modalOverlay').classList.remove('open');
        },
        
        closeModalOverlay(event) {
          if (event.target === document.getElementById('modalOverlay')) {
            this.closeModal();
          }
        },
        
        filterStudents() {
          const query = document.getElementById('modalSearch').value.trim().toLowerCase();
          const filtered = query 
            ? STUDENTS.filter(s => 
                s.nombre.toLowerCase().includes(query) || 
                s.nie.includes(query)
              )
            : STUDENTS;
          this.renderList(filtered, query);
        },
        
        renderList(students, query = '') {
          const container = document.getElementById('modalList');
          
          if (!students.length) {
            container.innerHTML = `
              <div class="modal-no-results">
                <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                No se encontraron estudiantes
              </div>
            `;
            return;
          }
          
          container.innerHTML = students.map(s => `
            <div class="modal-item ${state.selectedStudent?.nie === s.nie ? 'selected' : ''}" 
                 onclick="app.selectStudent(${s.no - 1})"
                 data-nie="${s.nie}">
              <div class="modal-num">${s.no}</div>
              <div class="modal-info">
                <div class="est-name">${utils.highlightText(s.nombre, query)}</div>
                <div class="est-nie">NIE: ${utils.highlightText(s.nie, query)}</div>
              </div>
              ${state.selectedStudent?.nie === s.nie ? '<span style="color: var(--gold); font-size: 20px;">‚úì</span>' : ''}
            </div>
          `).join('');
        },
        
        selectStudent(index) {
          const student = STUDENTS[index];
          state.selectedStudent = student;
          
          const data = {
            nombre: student.nombre,
            nie: student.nie,
            sexo: student.sexo,
            grado: '1¬∞ A√±o General',
            anio: new Date().getFullYear().toString(),
            turno: utils.getAutoShift()
          };
          
          this.setStudentData(data);
          this.highlightFields();
          this.saveStudentData();
          this.closeModal();
          
          notifications.success(`Estudiante ${student.nombre} seleccionado`, 'Estudiante');
          
          // Guardar en historial
          historyManager.save();
        },
        
        setStudentData(data) {
          document.getElementById('nombreEstudiante').value = data.nombre || '';
          document.getElementById('nie').value = data.nie || '';
          document.getElementById('sexo').value = data.sexo || '';
          document.getElementById('grado').value = data.grado || '';
          document.getElementById('turno').value = data.turno || '';
          document.getElementById('anio').value = data.anio || '';
        },
        
        getStudentData() {
          return {
            nombre: document.getElementById('nombreEstudiante').value,
            nie: document.getElementById('nie').value,
            sexo: document.getElementById('sexo').value,
            grado: document.getElementById('grado').value,
            turno: document.getElementById('turno').value,
            anio: document.getElementById('anio').value
          };
        },
        
        highlightFields() {
          const fields = ['nombreEstudiante', 'nie', 'sexo', 'grado', 'turno', 'anio'];
          fields.forEach(id => {
            const el = document.getElementById(id);
            el.style.transition = 'all 0.3s ease';
            el.style.background = '#e8f5e9';
            el.style.borderColor = '#4caf50';
            setTimeout(() => {
              el.style.background = '';
              el.style.borderColor = '';
            }, 800);
          });
        },
        
        saveStudentData() {
          utils.saveToStorage(CONFIG.STUDENT_KEY, this.getStudentData());
        },
        
        loadStudentData() {
          const data = utils.loadFromStorage(CONFIG.STUDENT_KEY);
          if (data) {
            this.setStudentData(data);
            // Buscar estudiante en la lista
            state.selectedStudent = STUDENTS.find(s => s.nie === data.nie) || null;
          }
        }
      };
      
      // ==================== GESTI√ìN DE TABLA ====================
      
      const tableManager = {
        tbody: document.getElementById('tabla'),
        
        createRow(data = null) {
          if (state.rowCount >= CONFIG.MAX_ROWS) {
            notifications.warning(`M√°ximo de ${CONFIG.MAX_ROWS} filas alcanzado`);
            return null;
          }
          
          state.rowCount++;
          const rowId = utils.generateId();
          
          const tr = document.createElement('tr');
          tr.dataset.rowId = rowId;
          tr.innerHTML = `
            <td class="num">${state.rowCount}</td>
            <td>
              <input type="date" class="fecha-input" value="${data?.fecha || utils.formatDate()}">
            </td>
            <td class="desc">
              <textarea placeholder="Descripci√≥n..." rows="2">${data?.descripcion || ''}</textarea>
            </td>
            <td class="check-dem">
              <input type="checkbox" class="dem" data-type="dem" data-letter="A" 
                ${data?.dem?.includes('A') ? 'checked' : ''}>
            </td>
            <td class="check-dem">
              <input type="checkbox" class="dem" data-type="dem" data-letter="B" 
                ${data?.dem?.includes('B') ? 'checked' : ''}>
            </td>
            <td class="check-dem">
              <input type="checkbox" class="dem" data-type="dem" data-letter="C" 
                ${data?.dem?.includes('C') ? 'checked' : ''}>
            </td>
            <td class="check-dem">
              <input type="checkbox" class="dem" data-type="dem" data-letter="D" 
                ${data?.dem?.includes('D') ? 'checked' : ''}>
            </td>
            <td class="check-red">
              <input type="checkbox" class="red" data-type="red" data-letter="A" 
                ${data?.red?.includes('A') ? 'checked' : ''}>
            </td>
            <td class="check-red">
              <input type="checkbox" class="red" data-type="red" data-letter="B" 
                ${data?.red?.includes('B') ? 'checked' : ''}>
            </td>
            <td class="check-red">
              <input type="checkbox" class="red" data-type="red" data-letter="C" 
                ${data?.red?.includes('C') ? 'checked' : ''}>
            </td>
            <td class="check-rec">
              <input type="checkbox" class="rec" data-type="rec" data-letter="A" 
                ${data?.rec?.includes('A') ? 'checked' : ''}>
            </td>
            <td class="check-rec">
              <input type="checkbox" class="rec" data-type="rec" data-letter="B" 
                ${data?.rec?.includes('B') ? 'checked' : ''}>
            </td>
            <td>
              <input type="text" class="inline" placeholder="Nombre docente" value="${data?.docente || ''}">
            </td>
            <td>
              <input type="text" class="inline" placeholder="Firma responsable" value="${data?.firmaPadre || ''}">
            </td>
            <td>
              <input type="text" class="inline" placeholder="Firma estudiante" value="${data?.firmaEst || ''}">
            </td>
            <td class="del-cell">
              <button onclick="app.deleteRow(this)" title="Eliminar fila">‚úï</button>
            </td>
          `;
          
          // Animaci√≥n de entrada
          tr.style.opacity = '0';
          tr.style.transform = 'translateY(-10px)';
          setTimeout(() => {
            tr.style.transition = 'all 0.3s ease';
            tr.style.opacity = '1';
            tr.style.transform = 'translateY(0)';
          }, 10);
          
          return tr;
        },
        
        addRow(data = null) {
          const row = this.createRow(data);
          if (row) {
            this.tbody.appendChild(row);
            this.updateEmptyState();
            calculations.recalculate();
            
            // Scroll a la nueva fila
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Guardar en historial
            historyManager.save();
            
            return row;
          }
          return null;
        },
        
        deleteRow(btn) {
          const rows = this.tbody.querySelectorAll('tr');
          if (rows.length <= 1) {
            notifications.warning('Debe mantener al menos una fila');
            return;
          }
          
          const row = btn.closest('tr');
          
          // Confirmaci√≥n para filas con datos
          const hasData = row.querySelectorAll('input[type="checkbox"]:checked').length > 0 ||
                         row.querySelector('textarea').value.trim() !== '';
          
          if (hasData && !confirm('¬øEliminar esta fila con datos?')) {
            return;
          }
          
          // Animaci√≥n de salida
          row.style.transition = 'all 0.3s ease';
          row.style.opacity = '0';
          row.style.transform = 'translateX(-20px)';
          
          setTimeout(() => {
            row.remove();
            this.renumberRows();
            calculations.recalculate();
            this.updateEmptyState();
            historyManager.save();
            notifications.success('Fila eliminada', 'Eliminado');
          }, 300);
        },
        
        renumberRows() {
          const rows = this.tbody.querySelectorAll('tr');
          rows.forEach((tr, i) => {
            const numCell = tr.querySelector('.num');
            if (numCell) {
              numCell.textContent = i + 1;
            }
          });
          state.rowCount = rows.length;
        },
        
        generateTable(n = CONFIG.DEFAULT_ROWS) {
          this.tbody.innerHTML = '';
          state.rowCount = 0;
          
          for (let i = 0; i < n; i++) {
            const row = this.createRow();
            if (row) {
              this.tbody.appendChild(row);
            }
          }
          
          this.updateEmptyState();
        },
        
        updateEmptyState() {
          const emptyState = document.getElementById('emptyState');
          const hasRows = this.tbody.querySelectorAll('tr').length > 0;
          emptyState.style.display = hasRows ? 'none' : 'block';
        },
        
        updateRowDescription(row) {
          const textarea = row.querySelector('.desc textarea');
          const lines = [];
          
          // Dem√©ritos
          row.querySelectorAll('.dem:checked').forEach(cb => {
            const type = DEMERIT_TYPES.dem.find(d => d.letter === cb.dataset.letter);
            if (type) {
              lines.push(`D-${cb.dataset.letter}) ${type.desc}`);
            }
          });
          
          // Redenciones
          row.querySelectorAll('.red:checked').forEach(cb => {
            const type = DEMERIT_TYPES.red.find(d => d.letter === cb.dataset.letter);
            if (type) {
              lines.push(`R-${cb.dataset.letter}) ${type.desc}`);
            }
          });
          
          // Reconocimientos
          row.querySelectorAll('.rec:checked').forEach(cb => {
            const type = DEMERIT_TYPES.rec.find(d => d.letter === cb.dataset.letter);
            if (type) {
              lines.push(`RC-${cb.dataset.letter}) ${type.desc}`);
            }
          });
          
          textarea.value = lines.join('\n');
        },
        
        getAllRowsData() {
          const rows = [];
          this.tbody.querySelectorAll('tr').forEach(tr => {
            const data = {
              fecha: tr.querySelector('.fecha-input')?.value || '',
              descripcion: tr.querySelector('.desc textarea')?.value || '',
              dem: [...tr.querySelectorAll('.dem:checked')].map(cb => cb.dataset.letter),
              red: [...tr.querySelectorAll('.red:checked')].map(cb => cb.dataset.letter),
              rec: [...tr.querySelectorAll('.rec:checked')].map(cb => cb.dataset.letter),
              docente: tr.querySelector('td:nth-child(13) input')?.value || '',
              firmaPadre: tr.querySelector('td:nth-child(14) input')?.value || '',
              firmaEst: tr.querySelector('td:nth-child(15) input')?.value || ''
            };
            rows.push(data);
          });
          return rows;
        },
        
        loadRowsData(rowsData) {
          this.tbody.innerHTML = '';
          state.rowCount = 0;
          
          rowsData.forEach(data => {
            const row = this.createRow(data);
            if (row) {
              this.tbody.appendChild(row);
            }
          });
          
          this.updateEmptyState();
        },
        
        filterTable(query, type = 'all') {
          const rows = this.tbody.querySelectorAll('tr');
          
          rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const hasDem = row.querySelectorAll('.dem:checked').length > 0;
            const hasRed = row.querySelectorAll('.red:checked').length > 0;
            const hasRec = row.querySelectorAll('.rec:checked').length > 0;
            
            const matchesQuery = !query || text.includes(query.toLowerCase());
            let matchesType = true;
            
            if (type === 'dem') matchesType = hasDem;
            else if (type === 'red') matchesType = hasRed;
            else if (type === 'rec') matchesType = hasRec;
            
            if (matchesQuery && matchesType) {
              row.classList.remove('hidden');
            } else {
              row.classList.add('hidden');
            }
          });
        }
      };
      
      // ==================== C√ÅLCULOS ====================
      
      const calculations = {
        recalculate() {
          const dem = document.querySelectorAll('.dem:checked').length;
          const red = document.querySelectorAll('.red:checked').length;
          const rec = document.querySelectorAll('.rec:checked').length;
          const net = Math.max(0, dem - red);
          
          // Actualizar contadores con animaci√≥n
          this.animateValue('totalDem', parseInt(document.getElementById('totalDem').textContent), dem);
          this.animateValue('totalRed', parseInt(document.getElementById('totalRed').textContent), red);
          this.animateValue('totalNet', parseInt(document.getElementById('totalNet').textContent), net);
          this.animateValue('totalRec', parseInt(document.getElementById('totalRec').textContent), rec);
          
          // Barra de progreso
          const pct = Math.min(100, (net / 15) * 100);
          const bar = document.getElementById('progressBar');
          bar.style.width = pct + '%';
          document.getElementById('progressLabel').textContent = `${net} / 15`;
          
          // Color de la barra
          const colors = [
            { threshold: 15, color: '#c0392b' },
            { threshold: 10, color: '#e74c3c' },
            { threshold: 6, color: '#e67e22' },
            { threshold: 3, color: '#f1c40f' },
            { threshold: 0, color: '#27ae60' }
          ];
          
          const color = colors.find(c => net >= c.threshold)?.color || '#27ae60';
          bar.style.background = color;
          
          // Sanci√≥n
          const sanction = SANCTIONS.find(s => net >= s.min) || SANCTIONS[SANCTIONS.length - 1];
          const sanctionEl = document.getElementById('sancion');
          sanctionEl.className = `sanction ${sanction.cls}`;
          sanctionEl.innerHTML = `
            <div class="sanction-icon">${sanction.icon}</div>
            <div class="sanction-text">
              ${sanction.title}
              <small>${sanction.sub}</small>
            </div>
          `;
          
          // Guardar datos
          this.saveData();
        },
        
        animateValue(id, start, end) {
          if (start === end) return;
          
          const el = document.getElementById(id);
          const duration = 500;
          const startTime = performance.now();
          
          const animate = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeProgress = 1 - Math.pow(1 - progress, 3); // easeOutCubic
            const current = Math.round(start + (end - start) * easeProgress);
            
            el.textContent = current;
            
            if (progress < 1) {
              requestAnimationFrame(animate);
            }
          };
          
          requestAnimationFrame(animate);
        },
        
        saveData() {
          const data = {
            rows: tableManager.getAllRowsData(),
            timestamp: Date.now()
          };
          utils.saveToStorage(CONFIG.STORAGE_KEY, data);
        },
        
        loadData() {
          const data = utils.loadFromStorage(CONFIG.STORAGE_KEY);
          if (data && data.rows && data.rows.length > 0) {
            tableManager.loadRowsData(data.rows);
            this.recalculate();
          } else {
            tableManager.generateTable();
          }
        }
      };
      
      // ==================== MODALES DE CONFIRMACI√ìN ====================
      
      const confirmManager = {
        open(type, checkbox) {
          state.pendingCheckbox = checkbox;
          
          const bodyId = type === 'red' ? 'confirmRedBody' : 'confirmRecBody';
          const overlayId = type === 'red' ? 'confirmRedOverlay' : 'confirmRecOverlay';
          const letterClass = type === 'red' ? 'red-theme-letter' : 'rec-theme-letter';
          
          const types = DEMERIT_TYPES[type];
          const item = types.find(t => t.letter === checkbox.dataset.letter);
          
          if (item) {
            document.getElementById(bodyId).innerHTML = `
              <div class="confirm-item">
                <div class="confirm-letter ${letterClass}">${checkbox.dataset.letter}</div>
                <div class="confirm-item-text">${item.desc}</div>
              </div>
            `;
            document.getElementById(overlayId).classList.add('open');
          }
        },
        
        cancel(type) {
          if (state.pendingCheckbox) {
            state.pendingCheckbox.checked = false;
            state.pendingCheckbox = null;
          }
          document.getElementById(type === 'red' ? 'confirmRedOverlay' : 'confirmRecOverlay').classList.remove('open');
          calculations.recalculate();
        },
        
        accept(type) {
          document.getElementById(type === 'red' ? 'confirmRedOverlay' : 'confirmRecOverlay').classList.remove('open');
          if (state.pendingCheckbox) {
            const row = state.pendingCheckbox.closest('tr');
            tableManager.updateRowDescription(row);
            state.pendingCheckbox = null;
            calculations.recalculate();
            historyManager.save();
          }
        }
      };
      
      // ==================== EXPORTACI√ìN ====================
      
      const exportManager = {
        async pdf() {
          const btn = document.getElementById('btnPDF');
          const originalText = btn.innerHTML;
          
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span> Generando...';
          
          // Ocultar elementos de UI
          document.querySelectorAll('.del-cell, .table-controls').forEach(el => {
            el.style.display = 'none';
          });
          
          try {
            const element = document.getElementById('contenidoPDF');
            const canvas = await html2canvas(element, {
              scale: 2,
              useCORS: true,
              logging: false,
              backgroundColor: '#ffffff'
            });
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 190;
            const pageHeight = 277;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 10;
            
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            
            while (heightLeft > 0) {
              position = heightLeft - imgHeight + 10;
              pdf.addPage();
              pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
              heightLeft -= pageHeight;
            }
            
            const studentName = document.getElementById('nombreEstudiante').value.trim() || 'Estudiante';
            const safeName = studentName.replace(/[^a-z0-9√°√©√≠√≥√∫√±\s]/gi, '').replace(/\s+/g, '_');
            pdf.save(`Instrumento_001_${safeName}.pdf`);
            
            notifications.success('PDF generado correctamente', '√âxito');
          } catch (error) {
            console.error('Error generating PDF:', error);
            notifications.error('Error al generar el PDF. Intente nuevamente.', 'Error');
          } finally {
            document.querySelectorAll('.del-cell, .table-controls').forEach(el => {
              el.style.display = '';
            });
            btn.disabled = false;
            btn.innerHTML = originalText;
          }
        },
        
        excel() {
          try {
            const student = studentManager.getStudentData();
            const rows = tableManager.getAllRowsData();
            
            // Crear datos para Excel
            const data = rows.map((row, index) => ({
              'N¬∞': index + 1,
              'Fecha': row.fecha,
              'Descripci√≥n': row.descripcion,
              'Dem√©rito A': row.dem.includes('A') ? '‚úì' : '',
              'Dem√©rito B': row.dem.includes('B') ? '‚úì' : '',
              'Dem√©rito C': row.dem.includes('C') ? '‚úì' : '',
              'Dem√©rito D': row.dem.includes('D') ? '‚úì' : '',
              'Redenci√≥n A': row.red.includes('A') ? '‚úì' : '',
              'Redenci√≥n B': row.red.includes('B') ? '‚úì' : '',
              'Redenci√≥n C': row.red.includes('C') ? '‚úì' : '',
              'Reconoc. A': row.rec.includes('A') ? '‚úì' : '',
              'Reconoc. B': row.rec.includes('B') ? '‚úì' : '',
              'Docente': row.docente,
              'Firma Padre': row.firmaPadre,
              'Firma Estudiante': row.firmaEst
            }));
            
            // Agregar resumen al final
            const dem = rows.reduce((acc, r) => acc + r.dem.length, 0);
            const red = rows.reduce((acc, r) => acc + r.red.length, 0);
            const rec = rows.reduce((acc, r) => acc + r.rec.length, 0);
            const net = Math.max(0, dem - red);
            
            data.push({});
            data.push({
              'N¬∞': 'RESUMEN',
              'Fecha': '',
              'Descripci√≥n': `Estudiante: ${student.nombre || 'N/A'}`
            });
            data.push({
              'N¬∞': '',
              'Fecha': '',
              'Descripci√≥n': `NIE: ${student.nie || 'N/A'}`
            });
            data.push({
              'N¬∞': 'Dem√©ritos totales:',
              'Fecha': dem,
              'Descripci√≥n': ''
            });
            data.push({
              'N¬∞': 'Redenciones:',
              'Fecha': red,
              'Descripci√≥n': ''
            });
            data.push({
              'N¬∞': 'Dem√©ritos netos:',
              'Fecha': net,
              'Descripci√≥n': ''
            });
            data.push({
              'N¬∞': 'Reconocimientos:',
              'Fecha': rec,
              'Descripci√≥n': ''
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Dem√©ritos');
            
            const studentName = student.nombre || 'Estudiante';
            const safeName = studentName.replace(/[^a-z0-9√°√©√≠√≥√∫√±\s]/gi, '').replace(/\s+/g, '_');
            XLSX.writeFile(wb, `Instrumento_001_${safeName}.xlsx`);
            
            notifications.success('Archivo Excel generado correctamente', '√âxito');
          } catch (error) {
            console.error('Error generating Excel:', error);
            notifications.error('Error al generar el Excel', 'Error');
          }
        }
      };
      
      // ==================== INICIALIZACI√ìN ====================
      
      function init() {
        // Cargar datos guardados
        studentManager.loadStudentData();
        calculations.loadData();
        historyManager.init();
        
        // Event listeners
        setupEventListeners();
        
        // Atajos de teclado
        setupKeyboardShortcuts();
        
        notifications.success('Sistema cargado correctamente', 'Bienvenido');
      }
      
      function setupEventListeners() {
        // Cambios en checkboxes
        document.addEventListener('change', (e) => {
          if (e.target.matches('.dem, .red, .rec')) {
            const type = e.target.dataset.type;
            const row = e.target.closest('tr');
            
            if (type === 'red' && e.target.checked) {
              confirmManager.open('red', e.target);
            } else if (type === 'rec' && e.target.checked) {
              confirmManager.open('rec', e.target);
            } else {
              tableManager.updateRowDescription(row);
              calculations.recalculate();
              historyManager.save();
            }
          }
          
          // Guardar cambios en campos del estudiante
          if (e.target.matches('#nombreEstudiante, #nie, #sexo, #grado, #turno, #anio')) {
            studentManager.saveStudentData();
          }
        });
        
        // Input en campos de texto
        document.addEventListener('input', utils.debounce((e) => {
          if (e.target.matches('#nombreEstudiante, #nie, #grado, #anio, .inline, .desc textarea')) {
            studentManager.saveStudentData();
            calculations.saveData();
          }
        }, 500));
        
        // Cerrar modales con click fuera
        document.getElementById('confirmRedOverlay').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) confirmManager.cancel('red');
        });
        
        document.getElementById('confirmRecOverlay').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) confirmManager.cancel('rec');
        });
      }
      
      function setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
          // Escape para cerrar modales
          if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay.open, .confirm-overlay.open').forEach(el => {
              el.classList.remove('open');
            });
            if (state.pendingCheckbox) {
              state.pendingCheckbox.checked = false;
              state.pendingCheckbox = null;
            }
          }
          
          // Ctrl+N: Nueva fila
          if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            tableManager.addRow();
          }
          
          // Ctrl+Z: Deshacer
          if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            historyManager.undo();
          }
          
          // Ctrl+Y o Ctrl+Shift+Z: Rehacer
          if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
            e.preventDefault();
            historyManager.redo();
          }
          
          // Ctrl+P: Imprimir
          if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            window.print();
          }
          
          // Ctrl+S: Guardar PDF
          if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            exportManager.pdf();
          }
        });
      }
      
      // ==================== API P√öBLICA ====================
      
      return {
        // Inicializaci√≥n
        init,
        
        // Gesti√≥n de estudiantes
        openStudentModal: studentManager.openModal.bind(studentManager),
        closeStudentModal: studentManager.closeModal.bind(studentManager),
        closeModalOverlay: studentManager.closeModalOverlay.bind(studentManager),
        filterStudents: studentManager.filterStudents.bind(studentManager),
        selectStudent: studentManager.selectStudent.bind(studentManager),
        
        // Gesti√≥n de tabla
        addRow: tableManager.addRow.bind(tableManager),
        deleteRow: tableManager.deleteRow.bind(tableManager),
        filterTable: utils.debounce(() => {
          const query = document.getElementById('tableSearch').value;
          tableManager.filterTable(query, state.currentFilter);
        }, 300),
        
        // Filtros
        setFilter(type) {
          state.currentFilter = type;
          document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === type);
          });
          const query = document.getElementById('tableSearch').value;
          tableManager.filterTable(query, type);
          
          // Actualizar visualizaci√≥n de tarjetas
          document.querySelectorAll('.stat-card').forEach(card => {
            card.classList.remove('active');
          });
          if (type !== 'all') {
            const cardMap = { dem: 0, red: 1, rec: 3 };
            const cards = document.querySelectorAll('.stat-card');
            if (cards[cardMap[type]]) {
              cards[cardMap[type]].classList.add('active');
            }
          }
        },
        
        // Confirmaciones
        cancelConfirm: confirmManager.cancel.bind(confirmManager),
        acceptConfirm: confirmManager.accept.bind(confirmManager),
        
        // Exportaci√≥n
        exportPDF: exportManager.pdf.bind(exportManager),
        exportExcel: exportManager.excel.bind(exportManager),
        
        // Utilidades
        undo: historyManager.undo.bind(historyManager),
        
        clearForm() {
          if (!confirm('¬øLimpiar todo el formulario? Esta acci√≥n no se puede deshacer.\n\nSe perder√°n todos los datos no guardados.')) {
            return;
          }
          
          // Limpiar campos del estudiante
          ['nombreEstudiante', 'nie', 'grado', 'anio'].forEach(id => {
            document.getElementById(id).value = '';
          });
          document.getElementById('sexo').value = '';
          document.getElementById('turno').value = '';
          
          // Limpiar storage
          localStorage.removeItem(CONFIG.STUDENT_KEY);
          localStorage.removeItem(CONFIG.STORAGE_KEY);
          localStorage.removeItem(CONFIG.HISTORY_KEY);
          
          // Resetear estado
          state.selectedStudent = null;
          state.history = [];
          state.historyIndex = -1;
          
          // Regenerar tabla
          tableManager.generateTable();
          calculations.recalculate();
          
          notifications.success('Formulario limpiado correctamente', 'Limpiar');
        }
      };
    })();
    
    // Inicializar aplicaci√≥n
    document.addEventListener('DOMContentLoaded', app.init);
  </script>
</body>
</html>
